{% extends 'base.html' %}

{% block content %}
<div class="card" style="max-width: 900px; margin: 0 auto;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
            <h2><i class="fas fa-utensils"></i> 요리하기 (소비)</h2>
            <div style="margin-top:5px;">
                <label style="display:inline-block; margin-right:15px;">날짜:
                    <input type="date" id="usage_date" value="{{ target_date }}"
                        style="border:none; background:transparent; font-size:1.1em; color:var(--text-color); font-weight:bold;">
                </label>
                <label style="display:inline-block;">식사 구분:
                    <input type="text" id="meal_type" placeholder="예: 아침" list="meal_type_list"
                        style="background:var(--card-bg); border:1px solid var(--border-color); color:var(--text-color); padding:4px; width:120px;">
                </label>
                <datalist id="meal_type_list">
                    <option value="아침">
                    <option value="점심">
                    <option value="저녁">
                    <option value="간식">
                    <option value="야식">
                </datalist>
            </div>
        </div>
        <button onclick="submitUsage()" class="btn btn-primary">전체 저장</button>
    </div>

    <div class="table-container" style="margin-top:20px;">
        <table id="usageTable">
            <colgroup>
                <col style="width: 30%;">
                <col style="width: 15%;">
                <col style="width: 15%;">
                <col style="width: 20%;">
                <col style="width: 5%;">
            </colgroup>
            <thead>
                <tr>
                    <th>품목명 (재고)</th>
                    <th>수량</th>
                    <th>단위</th>
                    <th>예상 원가(원)</th>
                    <th>삭제</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be added here -->
            </tbody>
        </table>
        <button onclick="addItem()" class="btn btn-secondary" style="width:100%; margin-top:10px;"><i
                class="fas fa-plus"></i> 항목 추가</button>
    </div>

    <!-- Summary Section -->
    <div class="card" style="margin-top:20px; padding:15px; background:rgba(27, 67, 50, 0.05);">
        <div style="text-align:right;">
            <span class="text-muted" style="font-weight:bold; font-size:1.1em; color:var(--primary-color);">오늘 식사의 총
                가치(원가 합계):</span>
            <span id="totalCostDisplay"
                style="font-size:1.5em; font-weight:800; margin-left:10px; color:var(--primary-color);">0</span>
            <span style="font-weight:bold; color:var(--primary-color);">원</span>
        </div>
    </div>

    <!-- Hidden Data -->
    <select id="hidden_ingredients" style="display:none;">
        <option value="">선택</option>
        {% for ing in ingredients %}
        {% set stock = ing.purchases|sum(attribute='remaining_quantity') %}
        {% if stock > 0 %}
        <option value="{{ ing.id }}" data-unit="{{ ing.standard_unit }}" data-cost="{{ ing.estimated_cost }}">
            {{ ing.name }} (재고: {{ "{:.1f}".format(stock) }}{{ ing.standard_unit }})
        </option>
        {% endif %}
        {% endfor %}
    </select>

    <select id="hidden_units" style="display:none;">
        <option value="std" data-ratio="1">표준단위</option>
        {% for unit in units %}
        <option value="{{ unit.unit_name }}" data-ratio="{{ unit.ratio_to_standard }}">{{ unit.unit_name }}</option>
        {% endfor %}
    </select>
</div>

<script>
    function addItem() {
        const tbody = document.querySelector('#usageTable tbody');
        const tr = document.createElement('tr');

        // Clone Options
        const ingOptions = document.getElementById('hidden_ingredients').innerHTML;
        const unitOptions = document.getElementById('hidden_units').innerHTML;

        tr.innerHTML = `
            <td>
                <select class="form-control item-ing" onchange="updateRowUnit(this); calculateTotal();">
                    ${ingOptions}
                </select>
            </td>
            <td>
                <input type="number" step="0.1" class="form-control item-qty" placeholder="0" oninput="calculateTotal()">
            </td>
            <td>
                <select class="form-control item-unit" onchange="calculateTotal()">
                    ${unitOptions}
                </select>
            </td>
            <td>
                <input type="text" class="form-control item-cost" placeholder="0" readonly style="background:rgba(0,0,0,0.05); cursor:not-allowed;">
            </td>
            <td>
                <button onclick="this.closest('tr').remove(); calculateTotal();" style="color:var(--danger); background:none; border:none; font-size:1.2em;">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    }

    function updateRowUnit(select) {
        // When ingredient selected, try to auto-select its standard unit if possible, or just keep default
        // Actually, let's look for standard unit match in unit list if we want to be fancy.
        // For now, default to 'std' (Standard) is fine, or we can improve UX.
        calculateTotal();
    }

    function calculateTotal() {
        let grandTotal = 0;
        const rows = document.querySelectorAll('#usageTable tbody tr');

        rows.forEach(tr => {
            const ingSelect = tr.querySelector('.item-ing');
            const qtyInput = tr.querySelector('.item-qty');
            const unitSelect = tr.querySelector('.item-unit');
            const costInput = tr.querySelector('.item-cost');

            const selectedOption = ingSelect.options[ingSelect.selectedIndex];
            if (!selectedOption || !selectedOption.value) {
                costInput.value = '';
                return;
            }

            const unitCost = parseFloat(selectedOption.getAttribute('data-cost')) || 0; // Cost per standard unit
            const qty = parseFloat(qtyInput.value) || 0;

            // Unit conversion ratio
            const unitOption = unitSelect.options[unitSelect.selectedIndex];
            const ratio = parseFloat(unitOption ? unitOption.getAttribute('data-ratio') : 1) || 1;

            // If unit is "std", ratio is 1 (assuming item-ing data-unit matches standard). 
            // In hidden_units, 'std' has data-ratio=1. Real units have multipliers.
            // Formula: (Qty * Ratio) * CostPerStdUnit
            const estimatedCost = (qty * ratio) * unitCost;

            costInput.value = Math.round(estimatedCost).toLocaleString();
            grandTotal += estimatedCost;
        });

        document.getElementById('totalCostDisplay').innerText = Math.round(grandTotal).toLocaleString();
    }

    function submitUsage() {
        const date = document.getElementById('usage_date').value;
        const mealType = document.getElementById('meal_type').value;

        if (!date || !mealType) {
            alert("날짜와 식사 구분을 입력해주세요.");
            return;
        }

        const rows = document.querySelectorAll('#usageTable tbody tr');
        const items = [];

        for (let tr of rows) {
            const ingId = tr.querySelector('.item-ing').value;
            const qty = tr.querySelector('.item-qty').value;
            const unit = tr.querySelector('.item-unit').value;

            if (ingId && qty) {
                items.push({
                    ingredient_id: ingId,
                    amount: qty,
                    unit_name: unit
                });
            }
        }

        if (items.length === 0) {
            alert("최소 1개의 품목을 입력해주세요.");
            return;
        }

        fetch('/cook', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                usage_date: date,
                meal_type: mealType,
                items: items
            })
        })
            .then(res => res.json())
            .then(json => {
                if (json.success) {
                    window.location.href = "{{ url_for('dashboard') }}";
                } else {
                    alert('저장 실패');
                }
            })
            .catch(err => alert('오류 발생: ' + err));
    }

    // Init
    window.onload = function () {
        addItem();
    };
</script>
{% endblock %}