{% extends 'base.html' %}

{% block content %}
<div class="card" style="max-width: 900px; margin: 0 auto;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
            <h2><i class="fas fa-shopping-cart"></i> 장보기 (입고)</h2>
            <div style="margin-top:5px;">
                <label>날짜: <input type="date" id="tripDate" value="{{ target_date }}"
                        style="border:none; background:transparent; font-size:1.1em; color:var(--text-color);"></label>
                <label style="margin-left:15px;">장소: <input type="text" id="tripPlace" placeholder="마트명"
                        style="background:var(--card-bg); border:1px solid var(--border-color); color:var(--text-color); padding:4px;"></label>
            </div>
        </div>
        <button onclick="saveShoppingTrip()" class="btn btn-primary">전체 저장</button>
    </div>

    <div class="table-container" style="margin-top:20px;">
        <table id="purchaseTable">
            <colgroup>
                <col style="width: 30%;">
                <col style="width: 15%;">
                <col style="width: 15%;">
                <col style="width: 20%;">
                <col style="width: 15%;">
                <col style="width: 5%;">
            </colgroup>
            <thead>
                <tr>
                    <th>품목명</th>
                    <th>수량</th>
                    <th>단위</th>
                    <th>구매금액(원)</th>
                    <th>유통기한</th>
                    <th>삭제</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be added here -->
            </tbody>
        </table>
        <button onclick="addRow()" class="btn btn-secondary" style="width:100%; margin-top:10px;"><i
                class="fas fa-plus"></i> 항목 추가</button>
    </div>

    <!-- Discount / Total Section -->
    <div class="card" style="margin-top:20px; padding:15px; background:rgba(0,0,0,0.02);">
        <div style="display:flex; justify-content:flex-end; gap:20px; align-items:center;">
            <div>
                <span class="text-muted">입력 합계:</span>
                <span id="estimatedTotal" style="font-size:1.2em; font-weight:bold; margin-left:10px;">0</span> 원
            </div>
            <div>
                <span class="text-muted">실제 결제 금액 (할인 적용):</span>
                <input type="number" id="finalTotal" placeholder="전체 결제액"
                    style="width:150px; text-align:right; margin-left:10px; padding:8px; font-weight:bold; color:var(--success);">
                원
            </div>
        </div>
        <div style="text-align:right; margin-top:5px; font-size:0.9em; color:var(--text-muted);">
            * 실제 결제 금액을 입력하면 각 품목에 할인율이 자동 적용됩니다. (비워두면 합계 그대로 저장)
        </div>
    </div>

    <!-- Datalist for autocomplete -->
    <datalist id="ing_list">
        {% for ing in ingredients %}
        <option value="{{ ing.name }}">
            {% endfor %}
    </datalist>

</div>

<script>
    function addRow() {
        const tbody = document.querySelector('#purchaseTable tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
        <td><input type="text" class="p-name" list="ing_list" placeholder="품목명"></td>
        <td><input type="number" class="p-qty" step="0.01" placeholder="수량"></td>
        <td>
            <select class="p-unit">
                <option value="g">g</option>
                <option value="ml">ml</option>
                <option value="count">개</option>
            </select>
        </td>
        <td><input type="number" class="p-price" step="10" placeholder="금액"></td>
        <td><input type="date" class="p-expiry"></td>
        <td><button onclick="this.closest('tr').remove()" style="color:var(--danger); background:none; border:none;"><i class="fas fa-trash"></i></button></td>
    `;
        tbody.appendChild(tr);

        // Add listeners for auto-calc
        tr.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', calculateEstimatedTotal);
        });
    }

    function calculateEstimatedTotal() {
        let total = 0;
        document.querySelectorAll('.p-price').forEach(input => {
            const val = parseFloat(input.value) || 0;
            total += val;
        });
        document.getElementById('estimatedTotal').innerText = total.toLocaleString();
    }

    async function saveShoppingTrip() {
        const date = document.getElementById('tripDate').value;
        const place = document.getElementById('tripPlace').value;
        const rows = document.querySelectorAll('#purchaseTable tbody tr');

        if (rows.length === 0) {
            alert('품목을 추가해주세요.');
            return;
        }

        const items = [];
        for (let tr of rows) {
            const name = tr.querySelector('.p-name').value;
            const qty = tr.querySelector('.p-qty').value;
            const unit = tr.querySelector('.p-unit').value;
            const price = tr.querySelector('.p-price').value;
            const expiry = tr.querySelector('.p-expiry').value;

            if (!name || !qty || !price) {
                alert('필수 항목(품목명, 수량, 금액)을 모두 입력해주세요.');
                return;
            }

            items.push({ name, qty, unit, price, expiry });
        }

        const finalPayInput = document.getElementById('finalTotal').value;
        const totalPay = finalPayInput ? parseFloat(finalPayInput) : null;

        const res = await fetch('/purchase', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ date, place, items, total_pay: totalPay })
        });

        const json = await res.json();
        if (json.success) {
            window.location.href = "{{ url_for('inventory') }}";
        } else {
            alert('저장 실패');
        }
    }

    // Initial row
    addRow();
</script>
{% endblock %}